(function() { var debugMode = false; 
/*!
 * Kraken 2017 CrossView.
 * http://alizarion.github.io/kraken
 *
 * Kraken, v1.0.0
 * Apache 2.0 license.*/
function uiCodemirrorDirective(e,o){function r(e,r,s,c){var l=angular.extend({value:r.text()},o.codemirror||{},e.$eval(s.uiCodemirror),e.$eval(s.uiCodemirrorOpts)),u=n(r,l);t(u,s.uiCodemirror||s.uiCodemirrorOpts,e),a(u,c,e),i(u,s.uiRefresh,e),e.$on("CodeMirror",function(e,o){if(!angular.isFunction(o))throw new Error("the CodeMirror event requires a callback function");o(u)}),angular.isFunction(l.onLoad)&&l.onLoad(u)}function n(e,o){var r;return"TEXTAREA"===e[0].tagName?r=window.CodeMirror.fromTextArea(e[0],o):(e.html(""),r=new window.CodeMirror(function(o){e.append(o)},o)),r}function t(e,o,r){function n(o,r){angular.isObject(o)&&t.forEach(function(n){if(o.hasOwnProperty(n)){if(r&&o[n]===r[n])return;e.setOption(n,o[n])}})}if(o){var t=Object.keys(window.CodeMirror.defaults);r.$watch(o,n,!0)}}function a(o,r,n){r&&(r.$formatters.push(function(e){if(angular.isUndefined(e)||null===e)return"";if(angular.isObject(e)||angular.isArray(e))throw new Error("ui-codemirror cannot use an object or an array as a model");return e}),r.$render=function(){var n=r.$viewValue||"";e(function(){o.setValue(n)},300)},o.on("change",function(e){var o=e.getValue();o!==r.$viewValue&&n.$evalAsync(function(){r.$setViewValue(o),n.$applyAsync(function(){n.$broadcast("compose:update:yaml"),n.$emit("compose:update:yaml")})})}))}function i(o,r,n){r&&n.$watch(r,function(r,n){r!==n&&e(function(){o.refresh()})})}return{restrict:"EA",require:"?ngModel",compile:function(){if(angular.isUndefined(window.CodeMirror))throw new Error("ui-codemirror needs CodeMirror to work... (o rly?)");return r}}}angular.module("kraken",["kraken.codemirror","ui.layout","ui.bootstrap","ui.router","ncy-angular-breadcrumb"]).config(["$compileProvider","$locationProvider",function(e,o){o.html5Mode(!1),o.hashPrefix(""),e.aHrefSanitizationWhitelist(/^\s*(https?|data|mailto|chrome-extension):/)}]),angular.module("kraken").config(["$compileProvider",function(e){e.aHrefSanitizationWhitelist(/^\s*(https?|data|mailto|chrome-extension):/)}]),angular.module("kraken").config(["$stateProvider","$urlRouterProvider",function(e,o){e.state("home",{url:"/home",controller:"HomeCtrl",templateUrl:"app/components/home/home.html",controllerAs:"home",ncyBreadcrumb:{label:"Home"}}).state({name:"home.edit",url:"/edit",templateUrl:"app/components/edit/edit.html",controller:"EditCtrl",controllerAs:"edit",ncyBreadcrumb:{label:"Edit {{edit.currentProject.name}}"}}),o.otherwise("/home")}]),angular.module("kraken.codemirror",[]).constant("uiCodemirrorConfig",{}).directive("uiCodemirror",["$timeout","uiCodemirrorConfig",uiCodemirrorDirective]),angular.module("kraken").directive("krVisNetwork",["util","LogService",function(e,o){return{restrict:"EA",transclude:!1,scope:{options:"=",jsonCompose:"=",composes:"=",project:"=",events:"="},link:function(o,r,n){function t(){if(null!=o.jsonCompose){var n=e.composeToVis(o.composes,o.options),t=new vis.DataSet(n.nodes),s=new vis.DataSet(n.edges);i.network?(i.data.nodes.forEach(function(e){t.get(e.id)||i.data.nodes.remove(e.id)}),i.data.edges.forEach(function(e){s.get(e.id)||i.data.edges.remove(e.id)}),i.data.nodes.update(n.nodes),i.data.edges.update(n.edges)):(i.data={nodes:t,edges:s},i.network=new vis.Network(r[0],i.data,i.visOption)),angular.forEach(o.events,function(e,o){a.indexOf(String(o))>=0&&i.network.on(o,e)}),null!=o.events&&null!=o.events.onload&&angular.isFunction(o.events.onload)&&o.events.onload(graph)}}var a=["click","doubleclick","oncontext","hold","release","selectNode","selectEdge","deselectNode","deselectEdge","dragStart","dragging","dragEnd","hoverNode","blurNode","zoom","showPopup","hidePopup","startStabilizing","stabilizationProgress","stabilizationIterationsDone","stabilized","resize","initRedraw","beforeDrawing","afterDrawing","animationFinished"],i=this;i.network=null,i.data=null,i.visOption={autoResize:!0,height:"100%",width:"100%",interaction:{navigationButtons:!0,keyboard:!1},physics:{forceAtlas2Based:{gravitationalConstant:-26,centralGravity:.005,springLength:230,springConstant:.18},maxVelocity:146,solver:"forceAtlas2Based",timestep:.35,stabilization:{enabled:!0,iterations:2e3,updateInterval:50}},layout:{randomSeed:34}},o.$watch("jsonCompose",function(){t()}),o.$watch("options.displayLinks",function(){t()}),o.$watch("options.displayDependsOn",function(){t()}),o.$watch("options.displayVolumes",function(){t()})}}}]),angular.module("kraken").filter("encodeURI",[function(){return window.encodeURIComponent}]),angular.module("kraken").factory("Compose",["$rootScope",function(e){function o(o){var r=this;return o?(o.color="#"+Math.floor(16777215*Math.random()).toString(16),o.name||(o.name="initial-default-docker-compose.yml"),o.json||(o.json={version:2,services:{proxy:{image:"httpd",ports:["80:80"]}}})):o={name:"initial-default-docker-compose.yml",color:"#"+Math.floor(16777215*Math.random()).toString(16),json:{version:2,services:{proxy:{image:"httpd",ports:["80:80"]}}}},o.$yaml=jsyaml.safeDump(o.json),e.$on("compose:update:yaml",function(){r.$reloadFromYaml()}),angular.extend(r,o||{})}return o.prototype.$reloadFromYaml=function(){this.$yaml&&(this.json=jsyaml.safeLoad(this.$yaml))},o.prototype.$reloadFromJson=function(){this.json&&(this.$yaml=jsyaml.safeDump(this.json))},o}]),angular.module("kraken").factory("Project",["Compose","LocalFileReader","$q","$window",function(e,o,r,n){function t(o){var r=this;return r.composes=[],r.id=(new Date).getTime(),o&&(o.id&&(r.id=o.id),o.name&&(r.name=o.name),o.composes&&angular.forEach(o.composes,function(o){r.composes.push(new e(o))})),r}return t.prototype.$save=function(){var o=localStorage.getItem("kraken_projects"),r=[];o&&(r=angular.fromJson(o));var n=this;n.composes.length<=0&&n.composes.push(new e);var a=t.$getById(this.id);a.position>=0&&r.splice(a.position,1),r.push(n),localStorage.setItem("kraken_projects",angular.toJson(r))},t.prototype.$refreshYamlFromJson=function(){var e=this;e.composes&&angular.forEach(e.composes,function(e){e.$reloadFromJson()})},t.$loadAll=function(){var e=localStorage.getItem("kraken_projects"),o=[],r=[];return e&&(o=angular.fromJson(e)),angular.forEach(o,function(e){r.push(new t(e))}),angular.forEach(r,function(e){e.$refreshYamlFromJson()}),r},t.prototype.getCompose=function(){var e=this,o=null;return angular.forEach(e.composes,function(e){o=angular.merge(e.json,o)}),o},t.$getById=function(e){var o=localStorage.getItem("kraken_projects"),r=[],n=null,t=-1;if(o){r=angular.fromJson(o);var a=!1;angular.forEach(r,function(o,r){a||o.id===e&&(n=o,t=r)})}return n||console.warn("project with id "+e+"not found"),{project:n,position:t}},t.prototype.$drop=function(){var e=n.confirm("Are you sure you want to delete this project?");if(e){var o=localStorage.getItem("kraken_projects"),r=[];o&&(r=angular.fromJson(o));var a=t.$getById(this.id);a.position>=0&&r.splice(a.position,1),localStorage.setItem("kraken_projects",angular.toJson(r))}},t.prototype.loadAllLocally=function(n){var t=this,a=r.defer(),i=[];return angular.forEach(n,function(r){i.push(o.readAsText(r).then(function(o){t.composes.push(new e({name:r.name,$yaml:o,json:jsyaml.safeLoad(o)}))}))}),r.all(i).then(function(){a.resolve(t.getCompose())},function(e){a.reject(e)}),a.promise},t}]),angular.module("kraken").directive("krFileSelect",[function(){return{restrict:"EA",scope:{getFile:"&"},link:function(e,o){o.bind("change",function(o){var r=(o.srcElement||o.target).files;e.getFile({files:r})})}}}]),function(e){var o=function(e,o,r){var n=function(e,o,r){return function(){r.$apply(function(){o.resolve(e.result)})}},t=function(e,o,r){return function(){r.$apply(function(){o.reject(e.result)})}},a=function(e,o){return function(e){o.$broadcast("fileProgress",{total:e.total,loaded:e.loaded})}},i=function(e,o){var r=new FileReader;return r.onload=n(r,e,o),r.onerror=t(r,e,o),r.onprogress=a(r,o),r},s=function(o){var n=e.defer(),t=i(n,r);return t.readAsText(o),n.promise};return{readAsText:s}};e.factory("LocalFileReader",["$q","$log","$rootScope",o])}(angular.module("kraken")),angular.module("kraken").service("LogService",[function(){var e=this;return e.history=[],{warn:function(o){e.history.push({type:"warning",message:o,date:new Date})},error:function(o){e.history.push({type:"danger",message:o,date:new Date})},info:function(o){e.history.push({type:"info",message:o,date:new Date})},history:e.history}}]).factory("$exceptionHandler",["$log","LogService",function(e,o){return function(r,n){o.error(r),e.warn(r,n)}}]),angular.module("kraken").service("ProjectService",["Project",function(e){var o=this;return o.refresh=function(){o.loadedProjects=e.$loadAll()},o.getLoadedProjects=function(){return o.loadedProjects},o.getCurrentProject=function(){return o.currentProject},o.setCurrentProject=function(e){o.currentProject=e},o}]),angular.module("kraken").service("util",["LogService",function(e){function o(e,o){return{id:"service-"+e+"-depends-on-service-"+o,from:"service-"+e,to:"service-"+o,arrows:"to",physics:!1,color:"#ffb5bd",dashes:[2,2,20,20],chosen:{edge:function(e,o,r){e.color=r?"#ff2841":"ffb5bd",e.label=""}},smooth:{enabled:!0,type:"discrete",roundness:.2}}}function r(e,o){return{id:"network-"+e,label:s+e,size:10,color:"red",shape:"icon",icon:{face:"FontAwesome",code:"",size:50,color:"#303336"},shadow:!0}}function n(e,o,r){return{id:"service-"+e+"-to-network-"+(o?o:"default"),from:"service-"+e,label:r?r:"",to:"network-"+(o?o:"default")}}function t(e,o,r){return{id:"volume-"+e,label:e,color:r}}function a(e,o,r){return{id:"service-"+e+"-to-volume-"+o,from:"service-"+e,label:r?r:"",dashes:[2,4],to:"volume-"+o}}function i(i,l){var u=[],d=[];for(var f in i){var p=null,m=i[f].json,v=i[f].color;if(m.networks){var h=m.networks;if("object"!=typeof m.networks&&Array.isArray(h))e.warn("expected an array of  networks, and simple string found");else for(var g in h){var y=h[g];if(y)if(y.external){if(y.external.name){var w=r(y.external.name);u.pushUnique(w),"default"===g&&(p=w)}}else u.pushUniqueNode(r(g));else u.pushUniqueNode(r(g))}}var k={};if(l&&l.displayVolumes&&m.volumes){var j=m.volumes;if(Array.isArray(j));else for(var b in j){var $=!1,C=j[b];j[b]&&C.external&&C.external.name&&(u.pushUniqueNode(t(C.external.name,m.color)),k[b]=C.external.name,$=!0),$||u.pushUniqueNode(t(b,m.color))}}p||u.pushUniqueNode(r("default"));var P;P=m.services?m.services:m;for(var A in P){var E=P[A];if(E){if(u.pushUniqueNode({id:"service-"+A,label:c+A,size:10,icon:{face:"FontAwesome",code:"",size:50,color:v},shape:"icon",shadow:!0}),E.networks)if(Array.isArray(E.networks)||"object"==typeof E.networks)for(var x in E.networks){var S=null,N=x,U=E.networks[N];if(Array.isArray(E.networks)?N=U?U:"":U&&U.aliases&&Array.isArray(U.aliases)&&angular.forEach(U.aliases,function(e){S=S?S+", "+(e?e:""):"aliases : "+(e?e:"")}),"default"===N&&p)d.pushUniqueNode(n(A,null,S));else{d.pushUniqueNode(n(A,N,S));var q={id:"network-"+N,label:s+N,size:10,color:"blue",shape:"icon",icon:{face:"FontAwesome",code:"",size:50,color:"#777"},shadow:!0};u.arrayNodeIndexOf(q)<0&&u.pushUniqueNode(r(N)),e.warn("service "+A+" linked with  unknown network : "+N)}}else e.warn("expected an array of services networks, simple string found");else p?d.pushUniqueNode(n(A,null,null)):d.pushUniqueNode(n(A,null,null));if(E.depends_on&&l.displayDependsOn)if(Array.isArray(E.depends_on))for(var D in E.depends_on)d.pushUniqueNode(o(A,E.depends_on[D]));else for(var L in E.depends_on)d.pushUniqueNode(o(A,L));if(l&&l.displayVolumes&&E.volumes){var j=E.volumes;if(Array.isArray(j))for(var b in j){var C=j[b].split(":");k[C[0]]?(u.pushUniqueNode(t(k[C[0]],C[1])),d.pushUniqueNode(a(A,k[C[0]],C[1]))):(u.pushUniqueNode(t(C[0],C[1])),d.pushUniqueNode(a(A,C[0],C[1])))}}if(l){var F=E.links,M=E.external_links,O=[];if(Array.isArray(F)&&(O=O.concat(F)),Array.isArray(M)&&(O=O.concat(M)),O)for(var I in O)if(O[I]){var z=O[I].split(":");d.pushUniqueNode({id:"service-"+A+"-to-service-"+z[0]+"-as-"+z[1],from:"service-"+A,label:l.displayLinks?z[1]?z[1]:z[0]:"",arrows:"to",physics:!1,color:{opacity:l.displayLinks?1:0},chosen:{edge:function(e,o,r){e.color=r?"#a100ff":"#a5e2ff",e.label=""}},smooth:{enabled:!0,type:"discrete",roundness:.2},dashes:!0,to:"service-"+z[0]})}}}}}return{edges:d,nodes:u}}var s="network : ",c="service : ";return{composeToVis:i}}]),angular.module("kraken").controller("EditCtrl",["Project","LogService","$timeout","ProjectService","$scope","Compose",function(e,o,r,n,t,a){var i=this;i.currentProject=n.getCurrentProject()||new e,i.active=0,i.options={displayLinks:!0,displayDependsOn:!0,displayVolumes:!0},i.refreshEditor=function(){r(function(){t.$broadcast("CodeMirror",function(e){e.refresh()})},250)},i.removeCompose=function(e,o,r){var r=i.currentProject.composes.indexOf(e);r>=0&&(i.currentProject.composes.splice(r,1),i.currentProject.getCompose()),i.active=r-1>=0?r-1:0,i.refreshEditor(),o.preventDefault()},i.changeName=function(e,o){var r=prompt("Please the new name of your compose file",e.name);r&&(angular.forEach(i.currentProject.composes,function(o){o.name===e.name&&(r.indexOf(".yml")<0&&(r+=".yml"),o.name=r+"")}),i.currentProject.$save()),i.refreshEditor(),o.preventDefault()},i.addNewCompose=function(e){var o=prompt("Please enter your docker compose file name",".yml");o&&i.currentProject.composes.push(new a({name:o})),i.refreshEditor(),e.preventDefault(),r(function(){i.active=i.currentProject.composes.length-1},100)},i.logService=o,i.downloadYaml=function(){var e=0,o=[];angular.forEach(i.currentProject.composes,function(){o.push(document.getElementById("downloadAnchorElem"+e)),e++}),setTimeout(function(){for(var e in o)o[e].click()},200)},i.editorOptions={lineWrapping:!0,lineNumbers:!0,matchTags:{bothTags:!0},extraKeys:{"Ctrl-Space":"autocomplete"},foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter","CodeMirror-lint-markers"],styleActiveLine:!0,theme:"dracula",lint:!0,mode:"text/x-yaml",smartIndent:!1,indentWithTabs:!1,commands:{save:function(){}}},i.refreshEditor()}]),angular.module("kraken").controller("HomeCtrl",["Project","$uibModal","$state","ProjectService","$scope",function(e,o,r,n,t){var a=this;a.projectService=n,a.projectService.refresh(),a.setCurrentProject=function(e){a.projectService.setCurrentProject(e),r.transitionTo("home.edit")},a.updateProjectName=function(e,o){var r=prompt("Please enter the new name of you project",e.name);r&&(e.name=r,e.$save()),o.preventDefault()},a.createNewProject=function(){o.open({animation:!0,template:'<div class="container-fluid"><form novalidate><div class="modal-header"> <h3 class="modal-title" id="modal-title">Create new project</h3> </div><div class="modal-body" id="modal-body"><div class="form-group"> <label for="usr">Project Name:</label> <input type="text" required minlength="2" ng-model="project.name" class="form-control" id="usr"> </div> <ul><li ng-repeat="compose in project.composes">{{compose.name}} : <b>services </b> <span ng-repeat="(key,value) in compose.json.services">{{key}}, </span> </li></ul><label  class="btn btn-primary btn-lg btn-block btn-file">Import your Docker Compose files (Optional)<input type="file" multiple accept=".yml" kr-file-select get-file="project.loadAllLocally(files)" class="hidden"> </label></div><div class="modal-footer"><button class="btn btn-primary" type="button" ng-click="ok()">OK</button> <button class="btn btn-warning" type="button" ng-click="cancel()">Cancel</button> </div></div></form>',controller:["$scope","Project","$uibModalInstance","ProjectService",function(e,o,r,n){e.project=new o,e.ok=function(){e.project.$save(),n.refresh(),r.close()},e.cancel=function(){r.close()}}]})}}]);
})();